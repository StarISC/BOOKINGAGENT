@page "/search"
@inject ILookupService LookupService
@inject ICruisePricingService PricingService
@inject Microsoft.Extensions.Options.IOptions<RoyalCaribbeanApiOptions> ApiOptions
@inject ISailingListService SailingListService
@using BookingAgent.Domain.Models

<PageTitle>Sailing search</PageTitle>

<section class="section-block">
    <h1>Sailing search</h1>
    <p>Use lookup data (regions, ports, ships, cabin categories) to prepare a pricing request. The form will call the pricing service with the selected filters.</p>
    <p class="muted">Current pricing mode: @(ApiOptions.Value.UseStub ? "Stub (sample data)" : "Live SOAP call")</p>
</section>

@if (isLoading)
{
    <p class="status">Loading lookup data…</p>
}
else if (loadError is not null)
{
    <p class="status">Error loading lookups: @loadError</p>
}
else
{
    <section class="section-block">
        <EditForm Model="@filters" OnValidSubmit="HandleSearch">
            <div class="info-grid">
                <div>
                    <label>Region</label>
                    <InputSelect class="form-select" @bind-Value="filters.RegionCode">
                        <option value="">Any</option>
                        @foreach (var r in regions)
                        {
                            <option value="@r.RegionCode">@r.RegionName (@r.RegionCode)</option>
                        }
                    </InputSelect>
                </div>
                <div>
                    <label>Port</label>
                    <InputSelect class="form-select" @bind-Value="filters.PortCode">
                        <option value="">Any</option>
                        @foreach (var p in ports)
                        {
                            <option value="@p.PortCode">@p.PortName (@p.PortCode)</option>
                        }
                    </InputSelect>
                </div>
                <div>
                    <label>Ship</label>
                    <InputSelect class="form-select" @bind-Value="filters.ShipCode" OnChange="OnShipChanged">
                        <option value="">Any</option>
                        @foreach (var s in ships)
                        {
                            <option value="@s.ShipCode">@s.ShipName (@s.ShipCode)</option>
                        }
                    </InputSelect>
                </div>
                <div>
                    <label>Cabin category</label>
                    <InputSelect class="form-select" @bind-Value="filters.CabinCategoryCode">
                        <option value="">Any</option>
                        @foreach (var c in cabinCategories)
                        {
                            <option value="@c.CategoryCode">@c.CategoryCode @c.Description</option>
                        }
                    </InputSelect>
                </div>
                <div>
                    <label>Start date</label>
                    <InputDate class="form-control" @bind-Value="filters.StartDate" />
                </div>
                <div>
                    <label>End date</label>
                    <InputDate class="form-control" @bind-Value="filters.EndDate" />
                </div>
                <div>
                    <label>Duration (nights)</label>
                    <InputNumber class="form-control" @bind-Value="filters.DurationNights" />
                </div>
                <div>
                    <label>Guest count</label>
                    <InputNumber class="form-control" @bind-Value="filters.GuestCount" />
                </div>
            </div>
            <button type="submit" class="btn btn-primary" disabled="@isSubmitting">Get pricing</button>
            @if (isSubmitting)
            {
                <span class="status">Requesting pricing…</span>
            }
        </EditForm>
    </section>

    @if (!string.IsNullOrEmpty(summary))
    {
        <section class="section-block">
            <h2>Current selection</h2>
            <p>@summary</p>
            <p class="muted">Pricing request sent using these inputs.</p>
        </section>
    }

    @if (pricingResult is not null)
    {
        <section class="section-block">
            <h2>Pricing result</h2>
            <p class="muted">Currently using sample data; will reflect live SOAP response once connected.</p>
            <div class="info-grid">
                <div>
                    <dl>
                        <dt>Reservation</dt>
                        <dd>@pricingResult.ReservationId</dd>
                        <dt>Ship</dt>
                        <dd>@pricingResult.SailingInfo?.SelectedSailing?.ShipCode</dd>
                        <dt>Start</dt>
                        <dd>@pricingResult.SailingInfo?.SelectedSailing?.Start?.ToString("yyyy-MM-dd")</dd>
                        <dt>Fare</dt>
                        <dd>@pricingResult.SailingInfo?.SelectedCategory?.FareCode</dd>
                    </dl>
                </div>
                <div>
                    <h3>Booking totals</h3>
                    <table class="rate-table">
                        <thead>
                            <tr><th>Type</th><th class="numeric">Amount</th></tr>
                        </thead>
                        <tbody>
                            @foreach (var bp in pricingResult.BookingPayment?.BookingPrices ?? new List<BookingPrice>())
                            {
                                <tr>
                                    <td>@bp.PriceTypeCode</td>
                                    <td class="numeric">@bp.Amount?.ToString("C")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div>
                    <h3>Payment schedule</h3>
                    <ul class="payment-list">
                        @foreach (var p in pricingResult.BookingPayment?.PaymentSchedule?.Payments ?? new List<Payment>())
                        {
                            <li>
                                <span>@p.PaymentNumber</span>
                                <span>@p.Amount?.ToString("C")</span>
                                <span>@p.DueDate?.ToString("yyyy-MM-dd")</span>
                            </li>
                        }
                    </ul>
                </div>
            </div>
            <h3>Guest pricing</h3>
            <div class="guest-grid">
                @foreach (var g in pricingResult.BookingPayment?.GuestPrices ?? new List<GuestPrice>())
                {
                    <article class="guest-card">
                        <h4>Guest @g.GuestRefNumber</h4>
                        <table class="rate-table small">
                            <thead>
                            <tr><th>Code</th><th class="numeric">Amount</th></tr>
                            </thead>
                            <tbody>
                            @foreach (var pi in g.PriceInfos)
                            {
                                <tr>
                                    <td>@pi.PriceTypeCode</td>
                                    <td class="numeric">@pi.Amount?.ToString("C")</td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    </article>
                }
            </div>
        </section>
    }
}

@if (sailings is not null && sailings.Count > 0)
{
    <section class="section-block">
        <h2>Sailing list</h2>
        <p class="muted">Showing results from @(ApiOptions.Value.UseStub ? "stub data" : "staging API")</p>
        <table class="rate-table">
            <thead>
                <tr>
                    <th>Ship</th>
                    <th>Package</th>
                    <th>Start</th>
                    <th>Duration</th>
                    <th>Departure</th>
                    <th>Arrival</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var s in sailings)
                {
                    <tr>
                        <td>@s.ShipCode</td>
                        <td>@s.CruisePackageCode</td>
                        <td>@s.StartDate?.ToString("yyyy-MM-dd")</td>
                        <td>@s.Duration</td>
                        <td>@s.DeparturePort</td>
                        <td>@s.ArrivalPort</td>
                    </tr>
                }
            </tbody>
        </table>
    </section>
}

@code {
    private bool isLoading = true;
    private bool isSubmitting;
    private string? loadError;
    private string? summary;
    private SearchFilters filters = new();
    private CruisePricingResult? pricingResult;
    private List<SailingOptionResult> sailings = new();

    private List<RegionLookup> regions = new();
    private List<PortLookup> ports = new();
    private List<ShipLookup> ships = new();
    private List<CabinCategoryLookup> cabinCategories = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            regions = (await LookupService.GetRegionsAsync()).ToList();
            ports = (await LookupService.GetPortsAsync()).ToList();
            ships = (await LookupService.GetShipsAsync()).ToList();
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnShipChanged(ChangeEventArgs args)
    {
        var shipCode = args.Value?.ToString() ?? string.Empty;
        filters.ShipCode = shipCode;
        cabinCategories.Clear();
        if (!string.IsNullOrWhiteSpace(shipCode))
        {
            try
            {
                cabinCategories = (await LookupService.GetCabinCategoriesAsync(shipCode)).ToList();
            }
            catch (Exception ex)
            {
                loadError = $"Cabin categories: {ex.Message}";
            }
        }
    }

    private async Task HandleSearch()
    {
        isSubmitting = true;
        summary = BuildSummary();
        var guests = new List<CruiseGuestCriteria>();
        var guestCount = filters.GuestCount ?? 1;
        for (int i = 0; i < guestCount; i++)
        {
            guests.Add(new CruiseGuestCriteria { Age = 30, Nationality = "US" });
        }

        var criteria = new CruisePriceCriteria
        {
            RegionCode = filters.RegionCode,
            PortCode = filters.PortCode,
            ShipCode = filters.ShipCode,
            CabinCategoryCode = filters.CabinCategoryCode,
            StartDate = filters.StartDate,
            EndDate = filters.EndDate,
            DurationNights = filters.DurationNights,
            CurrencyCode = "USD",
            Guests = guests
        };
        try
        {
            pricingResult = await PricingService.GetPriceAsync(criteria);
            var list = await SailingListService.GetSailingListAsync(criteria);
            sailings = list.ToList();
        }
        catch (Exception ex)
        {
            loadError = $"Pricing request failed: {ex.Message}";
        }
        isSubmitting = false;
        StateHasChanged();
    }

    private string BuildSummary()
    {
        var parts = new List<string>();
        if (!string.IsNullOrWhiteSpace(filters.RegionCode)) parts.Add($"Region: {filters.RegionCode}");
        if (!string.IsNullOrWhiteSpace(filters.PortCode)) parts.Add($"Port: {filters.PortCode}");
        if (!string.IsNullOrWhiteSpace(filters.ShipCode)) parts.Add($"Ship: {filters.ShipCode}");
        if (!string.IsNullOrWhiteSpace(filters.CabinCategoryCode)) parts.Add($"Cabin: {filters.CabinCategoryCode}");
        if (filters.StartDate.HasValue) parts.Add($"Start: {filters.StartDate:yyyy-MM-dd}");
        if (filters.EndDate.HasValue) parts.Add($"End: {filters.EndDate:yyyy-MM-dd}");
        if (filters.DurationNights.HasValue) parts.Add($"Nights: {filters.DurationNights}");
        return parts.Count == 0 ? "No filters selected." : string.Join(", ", parts);
    }

    private sealed class SearchFilters
    {
        public string? RegionCode { get; set; }
        public string? PortCode { get; set; }
        public string? ShipCode { get; set; }
        public string? CabinCategoryCode { get; set; }
        public DateOnly? StartDate { get; set; }
        public DateOnly? EndDate { get; set; }
        public int? DurationNights { get; set; }
        public int? GuestCount { get; set; } = 2;
    }
}
